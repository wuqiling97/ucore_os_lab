# Lab3

## 知识点

本实验涉及到了以下课程上提到的知识点：

1. 虚拟页式存储的概念
2. FIFO置换算法和扩展时钟算法

本实验涉及的其他知识点：

​     无

OS原理中很重要，但在实验中没有对应上的知识点：

1. 其余的局部页面置换算法
2. 全局页面置换算法
3. Belady现象

## 练习1

##### 给未被映射的地址映射上物理页

本实验需要补全 `do_pgfault` 函数当中的一小部分。该函数在用户访问的虚拟地址在物理地址当中没有映射的时候被调用，此时可能有两种情况：非法访存，或是合法访存但发生了缺页异常。所以该函数首先进行了合法性检查，在一切标志位都合法之后，就轮到了我们自己编写的部分。合法访存引起的异常有两种情况：

1. 该页面被放入了swap分区中
2. 第一次访问该页，仅在 `vma_struct vma` 当中存在，在页表中不存在

练习1需要处理情况2。首先获取页表指针，如果指针指向的内容为0，表明遇到了情况2，此时调用 `pgdir_alloc_page` 分配物理页即可，需要注意检查分配的结果，确保不为NULL。

##### 与答案的区别

我没有检查 `get_pte` 得到的页表指针是否为NULL，不过根据lab2的实现，只要create=1那么返回值就不为NULL，所以这个检查应该是多余的。

##### 请描述页目录项和页表中组成部分对ucore实现页替换算法的潜在用处

```
 31               12 11-9 8 7 6 5 4 3 2 1 0
+-------------------+----+-+-+-+-+-+-+-+-+-+
|   页基地址高20位   |忽略 |G|0|D|A|C|T|U|W|P|
+-------------------+----+-+-+-+-+-+-+-+-+-+
```

页表当中5,6两位分别代表访问(Access)和改写(Dirty)位，在实现扩展时钟算法的时候，这两位可以用于记录该页的历史访问情况，以此决定是否要将这个页面交换到外存上。

##### 如果ucore的缺页服务例程在执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

CPU会将异常的线性地址保存在CR2寄存器当中，然后查询中断例程的入口点。由于当前已经在内核态，所以不涉及特权级变化。CPU还会将CS, EIP, Error Code压入栈当中，最后跳转到异常服务地址。不过由于当前执行的异常服务为缺页服务，所以即使再次跳转到异常服务地址，也还会是当前服务，很有可能再次缺页。

## 练习2

##### 补充完成基于FIFO的页面替换算法

本练习需要处理练习1当中提到的情况1，也就是访问了在swap分区当中的页面。为了处理这个异常，只需要调用 `swap_in` 函数将对应的swap分区当中的页面调入内存，随后建立物理页面和虚拟地址的映射关系，最后将该物理页面标记为可交换即可。

练习的另一个任务是实现FIFO页面置换算法。对于FIFO循环链表，靠近头部的page表示更晚访问。因此在 `_fifo_map_swappable` 当中，只需要将entry置于head后面即可。在 `_fifo_swap_out_victim` 当中，只需要找到 `head->prev` 也就是链表的尾部，然后将其从链表当中删除，并置换出去即可。

##### 与答案的区别

`_fifo_swap_out_victim` 当中，我没有检查 `head->prev != head` 以及 le2page得到的page不为NULL，应该加上。

`do_pgfault` 中，没有检查 `swap_in` 返回值，但是这个函数本来就只会返回0，否则就是assert error，所以我觉得这个检查是多余的。

##### 如果要在ucore上实现"extended clock页替换算法"，现有的swap_manager框架是否足以支持在ucore中实现此算法？

现有的框架可以支持。只需要修改 `swap_out_victim` 函数，按照课堂所说的那样，从时钟指针处开始循环扫描，将标志位(Access, Dirty)做如下修改：

| (A, D) | 修改后 |
| ------ | ------ |
| 0 0    | 被置换 |
| 0 1    | 0 0    |
| 1 0    | 0 0    |
| 1 1    | 0 1    |

找到第一个(0, 0)之后，就可以将该页面置换出去。

此外，还需要硬件支持，在访问页面的时候需要将页表对应的(A, D)位置为1。

- 需要被换出的页的特征是什么?

  在时钟指针扫描过程中，第一个(A, D)=(0, 0)的页面将被换出。

- 在ucore中如何判断具有这样特征的页？

  读取页对应的PTE表，获取标志位当中的Access和Dirty即可

- 何时进行换入和换出操作？

  换入：缺页异常发生后，也就是需要访问的页不在物理内存当中。

  换出：物理内存已满，又有页面需要换入的时候。

















