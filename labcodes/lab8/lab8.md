# Lab7

## 知识点

本实验涉及到了以下课程上提到的知识点：

1. 管道
2. 文件系统和文件
3. VFS
4. inode
5. 文件描述符

本实验涉及的其他知识点：

1. ucore的文件系统架构

OS原理中很重要，但在实验中没有对应上的知识点：

1. RAID
2. I/O子系统

## 练习0

在复制了lab1-7的代码之后，需要做一些修改，包括：

`proc.c`: 

1. `alloc_proc` 初始化新增的成员变量，但是我用的是memset，故无需修改
2. `do_fork` 使用 `copy_files` 复制旧进程打开的文件

## 练习1

#### 完成读文件操作的实现

在实现过程中，主要修改的是`sfs_io_nolock`的代码，该函数的功能是给定一个文件的`inode`以及需要读写的偏移量和大小，转换成数据块级别的读写操作。主要调用的是两个函数：

- `sfs_bmap_load_nolock`: 该函数能够将文件数据块的便宜转换成硬盘空间块的数据块编号；
- `sfs_block_op` / `sfs_buff_op`：该函数接受硬盘空间数据块编号，并进行读写操作；

当然，用户希望读取的文件大小和偏移并非是和数据块一一对齐的，因此在边界情况的时候需要特殊处理，这也是这个实验的要点所在，需要判断偏移的开头未对齐部分和结尾未对齐部分专门进行处理，而中间部分则调用对齐的`block`级别操作进行处理。

实际上，跟踪函数`sfs_buff_op`的调用可以得知：该函数在进行设备操作的时候也是以块为单位的。如果要读取一个块内的小部分数据，就必须将数据块整体读出或整体写入。这与原理相关的部分也是契合的。

#### UNIX的PIPE机制 

管道是UNIX进程通讯的一种重要机制。管道文件可以映射到内存当中。

要实现PIPE机制，需要增加相关的系统调用（例如`SYS_pipe`），此后就可以统一的使用`write`和`read`接口进行读和写操作了。对于管道写入端进程，需要将管道文件设置为其stdout；对读出端进程，则设置为stdin。具体到uCore的实现，可以在`sfs_inode`数据结构中增加特殊的标记位确定是不是管道文件，同时增加两个信号量用于进行类似“生产者-消费者”问题的同步互斥控制。

## 练习2

#### 完成基于文件系统的执行程序机制的实现

相比Lab7，`load_icode`函数的参数有了较大的变化：首先，读取ELF文件不再从内存中读取，而是通过已经实现好的文件系统的`read`操作进行硬盘文件读取；其次，加入了任意大小参数`argc`和`argv`的功能，使得应用程序能够接受命令行参数输入。

针对ELF文件的硬盘读取方式，主要是通过调用`load_icode_read`函数完成，该函数又在文件系统之上调用了`read`和`seek`函数，基于SFS对文件进行读取和寻址操作，在实现的时候，需要依次将ELF头，`program header`以及真正的各个代码段数据段读入内存。

而对于命令行参数的实现，则是直接将相关的字符串拷贝到用户栈的顶端，并将最开始的栈指针放在`argc`的起始地址即可。需要注意的是，用户态的`initcode.S`和`umain.c`也需要做相应的改动，为了能够使得参数顺利传送到`main`函数中，需要将参数寄存器设置为`argc`和`argv`的地址。

#### UNIX的硬链接和软链接机制 

##### 硬链接

在创建时将目录项的名字设定为给定的名字，目录项的inode设置为链接目标的inode号即可，还需要增加链接目标的引用计数。删除的时候，减少链接目标的引用计数，归零的时候，删除链接目标。

##### 软链接

可以看做一种特殊的文件，文件的数据为目标文件/目录的路径。

创建的时候，需要将文件类型设置为软链接，并将其指向目标文件路径。

删除时跟普通文件相同。

在访问目录的时候需要做特殊处理，如果是软链接，则需要转移到目标路径。

